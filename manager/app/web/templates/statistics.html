<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistics</title>
    <link rel="icon" type="image/png" href="/static/favicon.png?version={{ version }}">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- App -->
    <link rel="stylesheet" href="/static/esup-runner.css?version={{ version }}">
    <script src="/static/esup-runner.js?version={{ version }}" defer></script>
</head>
<body class="{% if dark_mode_enabled %}theme-dark{% else %}theme-light{% endif %} container py-4">
    <div class="container">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h2 mb-2">Statistics</h1>
                        <p class="text-subtle mb-0">Usage overview based on task_stats.csv</p>
                    </div>
                    <div class="text-end">
                        <a href="/admin" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary cards -->
        <div class="row g-3 mb-4">
            <div class="col-12 col-md-6 col-lg-3">
                <div class="stat-item rounded p-3 h-100">
                    <h3 class="h6 text-uppercase text-subtle mb-1">Total tasks</h3>
                    <div class="fs-4 fw-bold">{{ total_tasks }}</div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="stat-item rounded p-3 h-100">
                    <h3 class="h6 text-uppercase text-subtle mb-1">Task types</h3>
                    <div class="fs-4 fw-bold">{{ unique_types }}</div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="stat-item rounded p-3 h-100">
                    <h3 class="h6 text-uppercase text-subtle mb-1">Establishments</h3>
                    <div class="fs-4 fw-bold">{{ unique_etabs }}</div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <div class="stat-item rounded p-3 h-100">
                    <h3 class="h6 text-uppercase text-subtle mb-1">Date range</h3>
                    <div class="fs-6 fw-bold">{{ date_range or 'N/A' }}</div>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="row g-3 mb-4">
            <div class="col-12 col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2 class="h5 mb-0">Tasks by type</h2>
                            <span class="text-subtle small">Pie chart</span>
                        </div>
                        <div class="ratio" style="--bs-aspect-ratio: 50%;">
                            <canvas id="tasksByTypeChart"></canvas>
                        </div>
                        <div id="tasksByTypeEmpty" class="text-center text-muted py-4" style="display: none;">
                            No data available for chart
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2 class="h5 mb-0">Tasks by establishment</h2>
                            <span class="text-subtle small">Pie chart</span>
                        </div>
                        <div class="ratio" style="--bs-aspect-ratio: 50%;">
                            <canvas id="tasksByEtabChart"></canvas>
                        </div>
                        <div id="tasksByEtabEmpty" class="text-center text-muted py-4" style="display: none;">
                            No data available for chart
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2 class="h5 mb-0">Monthly evolution</h2>
                            <span class="text-subtle small">Tasks per month</span>
                        </div>
                        <div class="ratio" style="--bs-aspect-ratio: 30%;">
                            <canvas id="tasksByMonthChart"></canvas>
                        </div>
                        <div id="tasksByMonthEmpty" class="text-center text-muted py-4" style="display: none;">
                            No data available for chart
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- By type -->
            <div class="col-12 col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="h5 mb-3">Tasks by type</h2>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th class="text-end">Count</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in by_type %}
                                    <tr>
                                        <td>{{ item.label }}</td>
                                        <td class="text-end fw-semibold">{{ item.count }}</td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="2" class="text-center text-muted py-4">No data</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- By etab -->
            <div class="col-12 col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="h5 mb-3">Tasks by establishment</h2>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Establishment</th>
                                        <th class="text-end">Count</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in by_etab %}
                                    <tr>
                                        <td>{{ item.label }}</td>
                                        <td class="text-end fw-semibold">{{ item.count }}</td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="2" class="text-center text-muted py-4">No data</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- By date -->
            <div class="col-12 col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <h2 class="h5 mb-3">Tasks by date</h2>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th class="text-end">Count</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in by_date %}
                                    <tr>
                                        <td>{{ item.label }}</td>
                                        <td class="text-end fw-semibold">{{ item.count }}</td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="2" class="text-center text-muted py-4">No data</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center text-subtle mt-4">
            <small>Source: {{ csv_path }} · Last update: {{ last_update }} · Runner Manager v{{ version }}</small>
        </div>
    </div>

    <script id="statistics-data" type="application/json">
        {{ {'by_type': by_type, 'by_etab': by_etab, 'by_date': by_date} | tojson }}
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        (function () {
            if (window.__statisticsChartsLoaded) {
                return;
            }
            window.__statisticsChartsLoaded = true;

            const statsData = JSON.parse(document.getElementById('statistics-data')?.textContent || '{}');
            const typeLabels = (statsData.by_type || []).map(item => item.label);
            const typeCounts = (statsData.by_type || []).map(item => item.count);
            const etabLabels = (statsData.by_etab || []).map(item => item.label);
            const etabCounts = (statsData.by_etab || []).map(item => item.count);
            const dateLabels = (statsData.by_date || []).map(item => item.label);
            const dateCounts = (statsData.by_date || []).map(item => item.count);

            const chartCanvas = document.getElementById('tasksByTypeChart');
            const emptyState = document.getElementById('tasksByTypeEmpty');
            const etabCanvas = document.getElementById('tasksByEtabChart');
            const etabEmpty = document.getElementById('tasksByEtabEmpty');
            const monthCanvas = document.getElementById('tasksByMonthChart');
            const monthEmpty = document.getElementById('tasksByMonthEmpty');

            if (!typeLabels.length || !chartCanvas) {
                if (emptyState) emptyState.style.display = 'block';
            } else {
                const colors = [
                    '#4e79a7', '#f28e2b', '#e15759', '#76b7b2', '#59a14f',
                    '#edc949', '#af7aa1', '#ff9da7', '#9c755f', '#bab0ab'
                ];
                new Chart(chartCanvas, {
                    type: 'pie',
                    data: {
                        labels: typeLabels,
                        datasets: [{
                            data: typeCounts,
                            backgroundColor: typeLabels.map((_, idx) => colors[idx % colors.length]),
                            borderWidth: 0,
                        }],
                    },
                    options: {
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: getComputedStyle(document.body).getPropertyValue('--bs-body-color') || '#fff',
                                }
                            }
                        }
                    }
                });
            }

            if (!etabLabels.length || !etabCanvas) {
                if (etabEmpty) etabEmpty.style.display = 'block';
            } else {
                const colors = [
                    '#4e79a7', '#f28e2b', '#e15759', '#76b7b2', '#59a14f',
                    '#edc949', '#af7aa1', '#ff9da7', '#9c755f', '#bab0ab'
                ];
                new Chart(etabCanvas, {
                    type: 'pie',
                    data: {
                        labels: etabLabels,
                        datasets: [{
                            data: etabCounts,
                            backgroundColor: etabLabels.map((_, idx) => colors[idx % colors.length]),
                            borderWidth: 0,
                        }],
                    },
                    options: {
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: getComputedStyle(document.body).getPropertyValue('--bs-body-color') || '#fff',
                                }
                            }
                        }
                    }
                });
            }

            const monthlyMap = new Map();
            dateLabels.forEach((label, idx) => {
                if (!label || label === 'unknown') return;
                const monthKey = label.slice(0, 7);
                const current = monthlyMap.get(monthKey) || 0;
                monthlyMap.set(monthKey, current + Number(dateCounts[idx] || 0));
            });
            const monthlyLabels = Array.from(monthlyMap.keys()).sort();
            const monthlyCounts = monthlyLabels.map(label => monthlyMap.get(label));

            if (!monthlyLabels.length || !monthCanvas) {
                if (monthEmpty) monthEmpty.style.display = 'block';
            } else {
                new Chart(monthCanvas, {
                    type: 'line',
                    data: {
                        labels: monthlyLabels,
                        datasets: [{
                            label: 'Tasks',
                            data: monthlyCounts,
                            borderColor: '#4e79a7',
                            backgroundColor: 'rgba(78, 121, 167, 0.2)',
                            fill: true,
                            tension: 0.2,
                            pointRadius: 3,
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { precision: 0 }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        })();
    </script>
</body>
</html>
