# ESUP Runner Manager — example configuration
#
# Copy this file to .env and adapt values:
#   cp .env.example .env
#
# Notes:
# - Generate tokens:      uv run scripts/generate_tokens.py
# - Generate admin hashes: uv run scripts/generate_passwords.py

# Manager URL configuration
MANAGER_PROTOCOL=http
MANAGER_HOST=0.0.0.0
MANAGER_PORT=8081

# Production/development settings
ENVIRONMENT=production
# Number of Uvicorn workers (for Gunicorn, production mode)
UVICORN_WORKERS=2

# Remove task files older than specified number of days
CLEANUP_TASK_FILES_DAYS=7

# Directory to store log files
LOG_DIRECTORY=/var/log/esup-runner
# Log level (DEBUG, INFO, WARNING, ERROR, CRITICAL)
LOG_LEVEL=INFO

# Runner storage access (shared storage between manager and runners)
RUNNERS_STORAGE_ENABLED=false
# Only used when RUNNERS_STORAGE_ENABLED=true
RUNNERS_STORAGE_PATH=/tmp/esup-runner

# Optional domain-based priorities.
# - PRIORITIES_ENABLED=false means no priority, all tasks are accepted regardless of their notify_url domain.
# - PRIORITIES_ENABLED=true means that tasks with notify_url domain different from PRIORITY_DOMAIN may be rejected when the quota of other-domain tasks is reached.
# - PRIORITY_DOMAIN is the domain that has priority (e.g. your institution domain), used only if PRIORITIES_ENABLED=true.
# - MAX_OTHER_DOMAIN_TASK_PERCENT is the maximum percentage of running tasks that can be from other domains (notify_url domain different from PRIORITY_DOMAIN), used only if PRIORITIES_ENABLED=true.
# Example: with 10 runners and MAX_OTHER_DOMAIN_TASK_PERCENT=20,
# at most floor(10*0.2)=2 running tasks can be from other domains.
PRIORITIES_ENABLED=false
PRIORITY_DOMAIN=example.org
MAX_OTHER_DOMAIN_TASK_PERCENT=25

# Visibility of the API documentation (public|private)
API_DOCS_VISIBILITY=public

# OpenAPI token handling
# - OPENAPI_ALLOW_QUERY_TOKEN: allow ?token=... for docs access (not recommended; leaks via logs/history)
OPENAPI_ALLOW_QUERY_TOKEN=false

# CORS (web UI / API)
# Comma-separated list; keep "*" only if CORS_ALLOW_CREDENTIALS=false.
CORS_ALLOW_ORIGINS=*
CORS_ALLOW_CREDENTIALS=false
CORS_ALLOW_METHODS=*
CORS_ALLOW_HEADERS=*

# Tokens accepted by the manager API (clients and runners)
# Format: AUTHORIZED_TOKENS__DESCRIPTION=token
AUTHORIZED_TOKENS__runners=CHANGE_ME_RUNNERS_TOKEN
AUTHORIZED_TOKENS__app=CHANGE_ME_APP_TOKEN

# Admin users (for /admin) — values must be bcrypt hashes
# Format: ADMIN_USERS__USERNAME="<bcrypt_hash>"
# Example generation: uv run scripts/generate_passwords.py
ADMIN_USERS__admin="CHANGE_ME_BCRYPT_HASH"

# Optional completion notify retry settings
# - COMPLETION_NOTIFY_MAX_RETRIES: Maximum number of retries for completion notify (default: 5)
# - COMPLETION_NOTIFY_RETRY_DELAY_SECONDS: Delay between retries in seconds (default: 60)
# - COMPLETION_NOTIFY_BACKOFF_FACTOR: Backoff factor for retry delay (default: 1.5, i.e. each retry delay is multiplied by this factor)
COMPLETION_NOTIFY_MAX_RETRIES=5
COMPLETION_NOTIFY_RETRY_DELAY_SECONDS=60
COMPLETION_NOTIFY_BACKOFF_FACTOR=1.5

# notify_url callback hardening
# The manager forwards the client's token to notify_url via Authorization: Bearer <token>.
# If you don't want the token forwarded, omit notify_url.

# Optional allowlist for notify_url hostnames (comma-separated). Empty means allow any (subject to private-network policy).
NOTIFY_URL_ALLOWED_HOSTS=

# Allow notify_url resolving to private/loopback networks (default false; set true only if you control internal callbacks)
NOTIFY_URL_ALLOW_PRIVATE_NETWORKS=false
