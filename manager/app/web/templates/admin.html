<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="15">
    <title>Runners Monitoring</title>
    <link rel="icon" type="image/png" href="/static/favicon.png?version={{ version }}">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- App -->
    <link rel="stylesheet" href="/static/esup-runner.css?version={{ version }}">
    <script src="/static/esup-runner.js?version={{ version }}" defer></script>
</head>
<body class="{% if dark_mode_enabled %}theme-dark{% else %}theme-light{% endif %} container py-4">

    <!-- Light/dark toggle -->
    <form id="theme-form"  method="post" action="/admin/toggle-theme" style="display: none">
      <input type="hidden" name="theme" id="theme-input" value="{{ dark_mode_enabled }}">
    </form>
    <div class="theme-toggle">
        <label>
            <input type="radio" name="theme" value="light" {% if not dark_mode_enabled %}checked{% endif %}>
            <i class="bi bi-sun"></i>
        </label>
        <label>
            <input type="radio" name="theme" value="dark" {% if dark_mode_enabled %}checked{% endif %}>
            <i class="bi bi-moon"></i>
        </label>
    </div>

    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
      <div class="d-flex align-items-center gap-3 admin-brand">
        <img src="/static/logo.png?version={{ version }}" alt="ESUP Runner logo" class="admin-brand-logo">
        <h1 class="mb-0">Runners Monitoring</h1>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button id="reload-config-btn" type="button" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-arrow-clockwise"></i>
          Reload config
        </button>
        <span id="reload-config-status" class="small text-subtle"></span>
      </div>
    </div>

    <!-- STATISTICS -->
    <div class="row g-3 mb-4">
      <!-- Credentials -->
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="stat-item rounded p-3 h-100">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3 class="h6 text-uppercase text-subtle mb-1">Credentials</h3>
              <div class="fs-6 fw-bold">Manager credentials ({{ admin_count }} administrators)</div>
            </div>
            <a href="/admin/credentials" class="btn btn-outline-light btn-sm rounded-circle" title="View Credentials" data-bs-toggle="tooltip">
              <i class="bi bi-arrow-right"></i>
            </a>
          </div>
        </div>
      </div>

      <!-- Documentation -->
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="stat-item rounded p-3 h-100">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3 class="h6 text-uppercase text-subtle mb-1">Documentations</h3>
              <div class="fs-6 fw-bold">Manager documentations (4)</div>
            </div>
            <a href="/admin/docs" class="btn btn-outline-light btn-sm rounded-circle" title="View Documentations" data-bs-toggle="tooltip">
              <i class="bi bi-arrow-right"></i>
            </a>
          </div>
        </div>
      </div>

      <!-- Logs -->
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="stat-item rounded p-3 h-100">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3 class="h6 text-uppercase text-subtle mb-1">Logs</h3>
              <div class="fs-6 fw-bold">Manager logs</div>
            </div>
            <a href="/logs" class="btn btn-outline-light btn-sm rounded-circle" title="View Logs" data-bs-toggle="tooltip">
              <i class="bi bi-arrow-right"></i>
            </a>
          </div>
        </div>
      </div>

      <!-- Online Runners -->
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="stat-item rounded p-3 h-100">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3 class="h6 text-uppercase text-subtle mb-1">Online Runners</h3>
              <div class="fs-6 fw-bold">{{ online_runners }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tasks -->
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="stat-item rounded p-3 h-100">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3 class="h6 text-uppercase text-subtle mb-1">Tasks</h3>
              <div class="fs-6 fw-bold">{{ total_tasks }} tasks</div>
            </div>
            <a href="/tasks" class="btn btn-outline-light btn-sm rounded-circle" title="View Tasks" data-bs-toggle="tooltip">
              <i class="bi bi-arrow-right"></i>
            </a>
          </div>
        </div>
      </div>

      <!-- Statitics -->
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="stat-item rounded p-3 h-100">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3 class="h6 text-uppercase text-subtle mb-1">Statistics</h3>
              <div class="fs-6 fw-bold">{{ tasks_this_month }} tasks this month</div>
            </div>
            <a href="/statistics" class="btn btn-outline-light btn-sm rounded-circle" title="View Statistics" data-bs-toggle="tooltip">
              <i class="bi bi-arrow-right"></i>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div class="row g-4">
      <!-- Runners -->
      <div class="col-12 col-lg-6">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <h2 class="h5 mb-3">Runners</h2>
            <div id="runners-list" class="list-group list-group-flush">
              {% for runner in runners | reverse %}
              <div class="list-group-item runner {{ runner.status }}">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="mb-1">
                      <a href="/admin/runner/{{ runner.id }}" class="link-body-emphasis" title="Open runner detail" data-bs-toggle="tooltip">
                        {{ runner.id }}
                      </a>
                      {% set runner_task_icons = {
                        'encoding': {'icon': 'bi-explicit', 'title': 'This runner handles encoding tasks.'},
                        'studio': {'icon': 'bi-record-btn', 'title': 'This runner handles studio tasks.'},
                        'transcription': {'icon': 'bi-badge-cc', 'title': 'This runner handles transcription tasks.'},
                      } %}
                      {% for t in runner.task_types %}
                        {% if runner_task_icons.get(t) %}&nbsp;<i title="{{ runner_task_icons[t].title }}" class="bi {{ runner_task_icons[t].icon }}" data-bs-toggle="tooltip"></i>{% endif %}
                      {% endfor %}
                    </h6>
                  </div>
                  <span class="badge {% if runner.status == 'online' %}bg-success{% else %}bg-danger{% endif %}">
                    {{ runner.status }}
                  </span>
                  <span class="badge {% if runner.availability == 'available' %}bg-primary{% else %}bg-secondary{% endif %}">
                    {{ runner.availability }}
                  </span>
                </div>
                <small class="text-subtle">
                  Last heartbeat: {{ runner.last_heartbeat }} ({{ runner.age_seconds }} s)
                </small>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Tasks -->
      <div class="col-12 col-lg-6">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <h2 class="h5 mb-3">Tasks</h2>
            <div id="tasks-list" class="list-group list-group-flush">
              {% for task in tasks %}
              <div class="list-group-item task {{ task.status }}">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="mb-1">
                        ID:
                        <a href="/admin/task/{{ task.id }}" class="link-body-emphasis" title="Open task detail" data-bs-toggle="tooltip">
                            {{ task.id }}
                        </a>
                        {% set task_icons = {
                          'encoding': {'icon': 'bi-explicit', 'title': 'Encoding task.'},
                          'studio': {'icon': 'bi-record-btn', 'title': 'Studio task.'},
                          'transcription': {'icon': 'bi-badge-cc', 'title': 'Transcription task.'}
                        } %}
                        {% if task_icons.get(task.task_type) %}&nbsp;<i title="{{ task_icons[task.task_type].title }}" class="bi {{ task_icons[task.task_type].icon }}" data-bs-toggle="tooltip"></i>{% endif %}
                    </h6>
                    <small class="text-subtle">Runner: {{ task.runner_id }} (<i>{{ task.created_at }}</i>)</small>
                  </div>
                  <span class="badge
                    {% if task.status == 'pending' %}bg-warning text-dark
                    {% elif task.status == 'running' %}bg-info text-dark
                    {% elif task.status == 'warning' %}bg-warning text-dark
                    {% elif task.status == 'completed' %}bg-success
                    {% elif task.status == 'failed' %}bg-danger
                    {% else %}bg-secondary{% endif %}">
                    {{ task.status }}
                  </span>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="text-center text-subtle">
        <small>Runner Manager v{{ version }} / Last update: {{ last_update }}</small>
    </div>

    <!-- Bootstrap 5 Javascript (with Popper.js for tooltips) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Activate all tooltips
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
      });
      // Toggle theme
      const radios = document.querySelectorAll('.theme-toggle input');
      const body = document.body;
      const form = document.getElementById('theme-form');
      const themeInput = document.getElementById('theme-input');
      const reloadBtn = document.getElementById('reload-config-btn');
      const reloadStatus = document.getElementById('reload-config-status');

      radios.forEach(radio => {
        radio.addEventListener('change', () => {
          const theme = radio.value;
          body.classList.toggle('theme-dark', theme === 'dark');
          body.classList.toggle('theme-light', theme === 'light');
          // Update hidden field
          themeInput.value = theme;

          // Automatic form submission
          form.submit();
        });
      });

      if (reloadBtn && reloadStatus) {
        reloadBtn.addEventListener('click', async () => {
          reloadBtn.disabled = true;
          reloadStatus.textContent = 'Reload en cours...';

          try {
            const response = await fetch('/admin/reload-config', {
              method: 'POST',
              headers: {
                'Accept': 'application/json'
              }
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            reloadStatus.textContent = `Reload OK (docs: ${data.api_docs_visibility})`;
          } catch (error) {
            reloadStatus.textContent = 'Reload échoué';
          } finally {
            setTimeout(() => {
              reloadStatus.textContent = '';
            }, 4000);
            reloadBtn.disabled = false;
          }
        });
      }
    </script>
</body>
</html>
